using Microsoft.Xna.Framework;
using Microsoft.Xna.Framework.Graphics;

namespace RhythmbulletPrototype.Rendering;

public sealed class BitmapTextRenderer
{
    private readonly Texture2D _pixel;

    public BitmapTextRenderer(Texture2D pixel)
    {
        _pixel = pixel;
    }

    public void DrawString(SpriteBatch spriteBatch, string text, Vector2 position, Color color, float scale = 1f)
    {
        var cursor = position;

        foreach (var ch in text.ToUpperInvariant())
        {
            var key = char.IsWhiteSpace(ch) ? ' ' : ch;
            if (!Glyphs.TryGetValue(key, out var rows))
            {
                rows = Glyphs['?'];
            }

            for (var y = 0; y < rows.Length; y++)
            {
                for (var x = 0; x < rows[y].Length; x++)
                {
                    if (rows[y][x] != '1')
                    {
                        continue;
                    }

                    var rect = new Rectangle(
                        (int)(cursor.X + x * scale),
                        (int)(cursor.Y + y * scale),
                        (int)MathF.Ceiling(scale),
                        (int)MathF.Ceiling(scale));
                    spriteBatch.Draw(_pixel, rect, color);
                }
            }

            cursor.X += 6f * scale;
        }
    }

    public Vector2 MeasureString(string text, float scale = 1f)
    {
        var width = text.Length * 6f * scale;
        var height = 7f * scale;
        return new Vector2(width, height);
    }

    private static readonly Dictionary<char, string[]> Glyphs = new()
    {
        [' '] = new[] { "00000", "00000", "00000", "00000", "00000", "00000", "00000" },
        ['?'] = new[] { "11110", "00010", "00100", "00100", "00000", "00100", "00000" },
        [':'] = new[] { "00000", "00100", "00000", "00000", "00100", "00000", "00000" },
        ['.'] = new[] { "00000", "00000", "00000", "00000", "00000", "00100", "00000" },
        ['-'] = new[] { "00000", "00000", "00000", "11111", "00000", "00000", "00000" },
        ['_'] = new[] { "00000", "00000", "00000", "00000", "00000", "00000", "11111" },
        ['+'] = new[] { "00000", "00100", "00100", "11111", "00100", "00100", "00000" },
        ['/'] = new[] { "00001", "00010", "00100", "01000", "10000", "00000", "00000" },
        ['%'] = new[] { "11001", "11010", "00100", "01000", "10110", "00110", "00000" },
        ['0'] = new[] { "01110", "10001", "10011", "10101", "11001", "10001", "01110" },
        ['1'] = new[] { "00100", "01100", "00100", "00100", "00100", "00100", "01110" },
        ['2'] = new[] { "01110", "10001", "00001", "00010", "00100", "01000", "11111" },
        ['3'] = new[] { "11110", "00001", "00001", "01110", "00001", "00001", "11110" },
        ['4'] = new[] { "00010", "00110", "01010", "10010", "11111", "00010", "00010" },
        ['5'] = new[] { "11111", "10000", "10000", "11110", "00001", "00001", "11110" },
        ['6'] = new[] { "01110", "10000", "10000", "11110", "10001", "10001", "01110" },
        ['7'] = new[] { "11111", "00001", "00010", "00100", "01000", "01000", "01000" },
        ['8'] = new[] { "01110", "10001", "10001", "01110", "10001", "10001", "01110" },
        ['9'] = new[] { "01110", "10001", "10001", "01111", "00001", "00001", "01110" },
        ['A'] = new[] { "01110", "10001", "10001", "11111", "10001", "10001", "10001" },
        ['B'] = new[] { "11110", "10001", "10001", "11110", "10001", "10001", "11110" },
        ['C'] = new[] { "01110", "10001", "10000", "10000", "10000", "10001", "01110" },
        ['D'] = new[] { "11110", "10001", "10001", "10001", "10001", "10001", "11110" },
        ['E'] = new[] { "11111", "10000", "10000", "11110", "10000", "10000", "11111" },
        ['F'] = new[] { "11111", "10000", "10000", "11110", "10000", "10000", "10000" },
        ['G'] = new[] { "01110", "10001", "10000", "10111", "10001", "10001", "01110" },
        ['H'] = new[] { "10001", "10001", "10001", "11111", "10001", "10001", "10001" },
        ['I'] = new[] { "01110", "00100", "00100", "00100", "00100", "00100", "01110" },
        ['J'] = new[] { "00001", "00001", "00001", "00001", "10001", "10001", "01110" },
        ['K'] = new[] { "10001", "10010", "10100", "11000", "10100", "10010", "10001" },
        ['L'] = new[] { "10000", "10000", "10000", "10000", "10000", "10000", "11111" },
        ['M'] = new[] { "10001", "11011", "10101", "10101", "10001", "10001", "10001" },
        ['N'] = new[] { "10001", "11001", "10101", "10011", "10001", "10001", "10001" },
        ['O'] = new[] { "01110", "10001", "10001", "10001", "10001", "10001", "01110" },
        ['P'] = new[] { "11110", "10001", "10001", "11110", "10000", "10000", "10000" },
        ['Q'] = new[] { "01110", "10001", "10001", "10001", "10101", "10010", "01101" },
        ['R'] = new[] { "11110", "10001", "10001", "11110", "10100", "10010", "10001" },
        ['S'] = new[] { "01111", "10000", "10000", "01110", "00001", "00001", "11110" },
        ['T'] = new[] { "11111", "00100", "00100", "00100", "00100", "00100", "00100" },
        ['U'] = new[] { "10001", "10001", "10001", "10001", "10001", "10001", "01110" },
        ['V'] = new[] { "10001", "10001", "10001", "10001", "10001", "01010", "00100" },
        ['W'] = new[] { "10001", "10001", "10001", "10101", "10101", "11011", "10001" },
        ['X'] = new[] { "10001", "10001", "01010", "00100", "01010", "10001", "10001" },
        ['Y'] = new[] { "10001", "10001", "01010", "00100", "00100", "00100", "00100" },
        ['Z'] = new[] { "11111", "00001", "00010", "00100", "01000", "10000", "11111" }
    };
}
